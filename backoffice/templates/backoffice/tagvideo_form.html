{% extends "backoffice/base.html" %}

{% load i18n bootstrap4 %}

{% block content %}
<div class="container">
    <h1 class="text-center pt-5">{% trans "Add a new smartlink" %}</h1>
    <div class="row pt-5">
        <!-- Video -->
        <div class="col-4">
            <div id="ytplayer"></div>
        </div>
        <!-- Tag -->
        <div class="col-4">
            <form class="form" method="POST" action="">
                {% csrf_token %}
                {% bootstrap_form form show_label=False %}
                {% buttons %}
                    <button class="btn btn-primary" type="submit">{% trans "Add" %}</button>
                {% endbuttons %}
            </form>
        </div>
        <!-- Tags list -->
        <div class="col-4">
            <table class="table">
              <thead>
                <tr class="row">
                  <th class="col-5">{% trans 'Smartlinks list' %}</th>
                  <th class="col-5"></th>
                  <th class="col-2"></th>
                </tr>
              </thead>
              <tbody>
                    {% for tag in tags_list %}
                        <tr class="row">
                            <td class="col-5">{{ tag.timestamp|time:'H:i:s' }}</td>
                            <td class="col-5">{{ tag.product.name }}</td>
                            <td class="col-2">
                                <form method="POST" action="{% url 'tagvideo_delete' tag.pk %}" %}">
                                   {% csrf_token %}
                                   <button type="submit" class="btn btn-danger">
                                    <i class="fas fa-trash-alt"></i>
                                   </button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </tbody>
</div>

{% endblock %}

{% block javascript %}
    function convert(seconds) {
        seconds = Number(seconds);
        var hours = Math.floor(seconds / 3600);
        var minutes = Math.floor(seconds % 3600 / 60);
        var seconds = Math.floor(seconds % 3600 % 60);
        hours = (hours == 0 ? "00": (hours < 10 ? "0" : "") + hours)
        minutes = (minutes == 0 ? "00": (minutes < 10 ? "0" : "") + minutes)
        seconds = (seconds == 0 ? "00": (seconds < 10 ? "0" : "") + seconds)
        return (hours + ":" + minutes + ":" + seconds); 
    }

  // 2. This code loads the IFrame Player API code asynchronously.
  var tag = document.createElement('script');

  tag.src = "https://www.youtube.com/iframe_api";
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  // 3. This function creates an <iframe> (and YouTube player)
  //    after the API code downloads.
  var player;
  function onYouTubeIframeAPIReady() {
    player = new YT.Player('ytplayer', {
      height: '250',
      width: '350',
      videoId: '{{ publication.get_youtube_video_id }}',
      events: {
        'onStateChange': onPlayerStateChange
      }
    });
  }

  // 5. The API calls this function when the player's state changes.
  //    The function indicates that when playing a video (state=1),
  //    the player should play for six seconds and then stop.
  var yt_timer;
  function onPlayerStateChange(event) {
    if (event.data == YT.PlayerState.PLAYING) {
      yt_timer = setInterval(getVideoTime, 100);
    }
    else {
      clearTimeout(yt_timer);
    }
  }
  function getVideoTime() {
    seconds = player.getCurrentTime();
    $("#id_timestamp").val(convert(seconds));
  }
{% endblock %}
